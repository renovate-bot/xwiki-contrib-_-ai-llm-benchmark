{"id": "extensions:Extension.LLM Application.Index for the LLM Application.WebHome", "url": "https://extensions.xwiki.org/xwiki/bin/view/Extension/LLM%20Application/Index%20for%20the%20LLM%20Application/", "title": "Index for the LLM Application (BETA)", "collection": "Eval", "mimetype": "text/markdown", "language": "en", "content": "\n\n\n| cog | **Provide a UI for configuring and managing the knowledge index.** |\n| --- | --- |\n\n\n\n| Type | XAR |\n| --- | --- |\n| Category | Application |\n| Developed by | Unknown |\n| Rating | *  * [1](# \"Poor\") * [2](# \"Satisfactory\") * [3](# \"Good\") * [4](# \"Very good\") * [5](# \"Excellent\")    0\u00a0Votes |\n| License | GNU Lesser General Public License 2.1 |\n\n\n\n| Compatibility | 16.2.0 and aboveDisconnected![Report issues](https://github.com/fregante/GhostText/issues) |\n| --- | --- |\n\n[Sources](https://github.com/xwiki-contrib/ai-llm/tree/main/application-ai-llm-index/application-ai-llm-index-ui)[Issues](https://jira.xwiki.org/browse/LLMAI)\n\nTable of contents\n\n* [Description](#HDescription)\n\t+ [Managing Collections](#HManagingCollections)\n\t+ [Managing Documents](#HManagingDocuments)\n\t+ [REST API](#HRESTAPI)\n\t\t- [Collections Resource](#HCollectionsResource)\n\t\t- [Collection Resource](#HCollectionResource)\n\t\t\t* [GET /wikis/{wikiName}/aiLLM/collections/{collectionName}](#HGET2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D)\n\t\t\t* [PUT /wikis/{wikiName}/aiLLM/collections/{collectionName}](#HPUT2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D)\n\t\t\t* [DELETE /wikis/{wikiName}/aiLLM/collections/{collectionName}](#HDELETE2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D)\n\t\t\t* [GET /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents](#HGET2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D2Fdocuments)\n\t\t- [Document Resource](#HDocumentResource)\n\t\t\t* [GET /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}](#HGET2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D2Fdocuments2F7BdocumentID7D)\n\t\t\t* [PUT /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}](#HPUT2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D2Fdocuments2F7BdocumentID7D)\n\t\t\t* [DELETE /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}](#HDELETE2Fwikis2F7BwikiName7D2FaiLLM2Fcollections2F7BcollectionName7D2Fdocuments2F7BdocumentID7D)\n\t+ [Authorization](#HAuthorization)\n\t\t- [External Authorization Checks](#HExternalAuthorizationChecks)\n\t\t- [Custom Authorization Checks](#HCustomAuthorizationChecks)\n# Description\n\nThe knowledge index provides a way to configure and manage an index of collections of documents that can provide additional context to chats in the [LLM Application](/xwiki/bin/view/Extension/LLM%20Application/). A technique called Retrieval Augmented Generation (RAG) is used to provide context to the chat completion. Context chunks that are semantically similar to the chat message are retrieved from the index and provided to the completion model. This allows the completion model to use knowledge from the index to generate more factual completions.\n\nThere are two ways to manage collections and the documents in them: through the UI that is provided in this extension or through the REST API. Right now, the extension primarily supports indexing external content, but in the future, it will also support indexing existing content that is already in the wiki.\n\n## Managing Collections\n\nThe AI application provides a simple interface for managing collections and their documents. When opening the AI application as admin, a link is provided at the bottom to open the Collections overview.\n\n![Collections overview, showing two collections in a table](/xwiki/bin/download/Extension/LLM%20Application/Index%20for%20the%20LLM%20Application/WebHome/1715154047321-673.png?width=960&height=421&rev=1.1)\n\nHere you can add a new collection or edit or delete an existing one. In the view of a collection, you can edit all properties, see the documents in the collection and add new documents. The name of the page of a document is a random value that is derived from the name of the collection. It doesn't use the name directly in order to support long document names, e.g., coming from an external application that might not be valid document names in XWiki. Renaming documents isn't supported at the moment as the primary use case is indexing external content. In a future version, it will be possible to index existing content of the wiki instead of managing the content separately.\n\n![View of a single collection with various properties and two documents in a table below it](/xwiki/bin/download/Extension/LLM%20Application/Index%20for%20the%20LLM%20Application/WebHome/1715154174040-332.png?width=960&height=968&rev=1.1)\n\nThe following properties can be edited:\n\n* **Title**: The display name of the collection\n* **Embedding Model**: The reference to the embedding model that can be configured in the models section of the AI application. This model is used to generate embeddings of parts (chunks) of the documents in the collection in order to support similarity search. By embedding the chat message in the same way, the similarity of the chat message to the documents in the collection can be calculated and the most relevant documents can be found.\n* **Chunking Method**: The method used to split the documents into chunks. Currently, only the maxChars method is supported, which splits the document into chunks of a maximum size with an overlap.\n* **Chunking Max Size**: The maximum size of a chunk in characters\n* **Chunking Overlap Offset**: The overlap of chunks in characters\n* **Allow Guests**: If guests can query this collection (as part of a chat completion)\n* **Query Groups**: The list of groups that are allowed to query this collection (as part of a chat completion). This is only used when guests aren't allowed to query the collection.\n* **Rights Check Method**: The method used for checking access rights of individual documents during queries. Supported values: public, external. See also [the Authorization section below](#HAuthorization).\n* **URL of the external rights check method**: The URL that is used to check rights for all found documents when the external rights check method is selected. This property is only displayed when the external rights check method is selected.\n\n## Managing Documents\n\nIn the view of a collection, you can see the documents in the collection and add new documents.\n\n![View of a single document \"WAISE Intro\"](/xwiki/bin/download/Extension/LLM%20Application/Index%20for%20the%20LLM%20Application/WebHome/1715154822895-528.png?width=650&height=478&rev=1.1)\n\nYou can configure the following properties of documents:\n\n* **Title**: The title of the document\n* **Language**: The language of the document (currently not used)\n* **URL**: The URL of the document, used to display a link to the original resource when the document is used as context in a chat\n* **Mime Type**: The mime type of the document, currently not used, could be used in the future to use a chunking method that is specific to the mime type\n* **Content**: The content of the document that is indexed\n\nAdditionally, you can attach files to a document and they will also be indexed if the content can be extracted by [Apache Tika](https://tika.apache.org/).\n\n## REST API\n\nThe REST API provides a convenient way to manage both collections and documents inside collections from external tools. This can be used in other applications to add, update and delete content that is indexed in the LLM application whenever content is added, changed or deleted the application.\n\n### Collections Resource\n\nGET /wikis/{wikiName}/aiLLM/collections\n\nReturns a list of all collection IDs that the current user can access as an array of strings.\n\n### Collection Resource\n\nA collection object has the following properties, all properties are strings unless otherwise mentioned:\n\n* id: id of the collection\n* title: pretty name of the collection\n* embedding\\_model: the embedding model as reference of the page that defines the model\n* chunking\\_method: the chunking method, should be maxChars\n* chunking\\_max\\_size: (int) the maximum size of a chunk\n* chunking\\_overlap\\_offset: (int) the overlap of chunks\n* document\\_spaces: (list of strings) the list of XWiki spaces indexed by this collection, currently not used\n* allow\\_guests: (boolean) if guests can query this collection (as part of a chat completion)\n* query\\_groups: (list of strings) the list of groups that are allowed to query this collection (as part of a chat completion). This is only used when guests aren't allowed to query the collection.\n* rights\\_check\\_method: the method used for checking access rights of individual documents during queries. Supported values: public, external. See also [the Authorization section below](#HAuthorization).\n* rights\\_check\\_method\\_configuration: (object) options of the rights check method, values depend on the selected rights check method. The \"external\" rights check method supports the url parameter which is the URL that is used to check rights for all found documents.\n\n#### GET /wikis/{wikiName}/aiLLM/collections/{collectionName}\n\nReturns the collection of the given name.\n\n#### PUT /wikis/{wikiName}/aiLLM/collections/{collectionName}\n\nCreates or updates the collection of the given name. The body of the request is a collection, if not all properties are specified, only the specified properties are updated.\n\n#### DELETE /wikis/{wikiName}/aiLLM/collections/{collectionName}\n\nDeletes the collection of the given name\n\n#### GET /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents\n\nReturns a list of document IDs that are contained in the collection of the given name. This resource supports the following query parameters:\n\n* start: the index of the first document to retrieve (default: 0)\n* number: the number of documents to retrieve (default: -1)\n\n### Document Resource\n\nA document object has the following properties, all properties are strings unless otherwise mentioned:\n\n* id: id of the document\n* title: pretty name of the document\n* language: the language of the document (currently not used)\n* url: the URL of the document, used to display a link to the original resource when the document is used as context in a chat\n* collection: the name of the collection the document is part of\n* mimetype: the mime type of the document, currently not used, could be used in the future to use a chunking method that is specific to the mime type\n* content: the content of the document that is indexed\n\n#### GET /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}\n\nReturns the document of the given name in the collection of the given name.\n\n#### PUT /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}\n\nCreates or updates the document of the given name in the collection of the given name. The body of the request is a document, if not all properties are specified, only the specified properties are updated.\n\n#### DELETE /wikis/{wikiName}/aiLLM/collections/{collectionName}/documents/{documentID}\n\nDeletes the document of the given name in the collection of the given name.\n\n## Authorization\n\nAt query time, regular XWiki access rights aren't checked. Instead, access to the indexed can be controlled at two levels:\n\n* **The collection:** It can be controlled which groups can query a collection in the configuration of the collection. A collection can also be allowed for guests, in this case no check is performed.\n* **The document:** On every collection, a method for checking rights for individual documents can be configured. After retrieving relevant chunks of context information, this rights checking method is asked for authorization for every retrieved document.\n\nBy default, two rights check methods are provided:\n\n* **Public**: this method just allows access to all documents. It is best suited when all users who have access to the collection should also be allowed to access all documents in it.\n* **External:** this method queries an external API via HTTP to check which documents can be accessed. It supports configuring a URL that is contacted on every query.\n\n### External Authorization Checks\n\nOn every query, a POST request with the following contents is submitted to the configured URL:\n\n* an array document\\_ids of document IDs as strings\n* a string that contains the user's name in XWiki in the form wiki:XWiki.Username\n* an object ldap\\_user with properties uid and dn if the user is connected to an [LDAP account from the LDAP Authenticator](/xwiki/bin/view/Extension/LDAP/Authenticator/)\n* an array jwt\\_users with objects with issuer and subject fields if the user is connected to one or several authorized applications configured in the [Token-based authentication for the LLM Application (BETA)](/xwiki/bin/view/Extension/LLM%20Application/Authenticator/)\n* an array oidc\\_users if the user is connected to one or several [OpenID Connect](/xwiki/bin/view/Extension/OpenID%20Connect/OpenID%20Connect%20Authenticator/) providers.\n\nIf you need to pass additional parameters like the collection name you can specify them as URL parameters.\n\nAn example request for a single document for the standard admin user could look like this:\n\n{\"document\\_ids\":[\"Performance\"],\"xwiki\\_username\":\"xwiki:XWiki.Admin\"}The response needs to be an object mapping document IDs to true or false, meaning that the user has or hasn't access to the respective document. To grant access to the \"Performance\" document in the example, the endpoint would need to reply {\"Performance\":true}. Any missing values or errors are interpreted as no access.\n\n### Custom Authorization Checks\n\nThe authorization system in the LLM application is designed to be fully extensible. To implement a custom authorization method, a component of type org.xwiki.contrib.llm.authorization.AuthorizationManagerBuilder needs to be implemented. If the authorization method needs any configuration, three additional parts need to be implemented:\n\n* A class to store the configuration that is serializable and unserializable using [Jackson](https://github.com/FasterXML/jackson). This class is mainly used to represent the configuration in the REST API for collections.\n* An XClass to store the configuration in the wiki page of the collection\n* A sheet to display the aforementioned XClass\n\nThe following shows an example component implemented in Groovy that can be used with the [Script Component Extension](/xwiki/bin/view/Extension/Script%20Component/):\n\npackage org.xwiki.contrib.llm.internal;  \n  \nimport javax.inject.Named  \nimport javax.inject.Singleton  \nimport org.xwiki.component.annotation.Component  \nimport org.xwiki.contrib.llm.authorization.AuthorizationManager  \nimport org.xwiki.contrib.llm.authorization.AuthorizationManagerBuilder  \nimport org.xwiki.contrib.llm.Collection  \nimport org.xwiki.model.reference.EntityReference  \nimport com.xpn.xwiki.objects.BaseObject  \nimport org.xwiki.model.reference.LocalDocumentReference  \n  \n/\\*\\*  \n\u00a0\\* A custom {@link AuthorizationManagerBuilder} that always returns true for all document ids.  \n\u00a0\\*  \n\u00a0\\* @version $Id$  \n\u00a0\\* @since 0.3  \n\u00a0\\*/  \n@Component  \n@Named(\"custom\")  \n@Singleton  \nclass CustomAuthorizationManagerBuilder implements AuthorizationManagerBuilder {  \n \u00a0\u00a0\u00a0static class ConfigurationType {  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0String property  \n  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0ConfigurationType(String property) {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0this.property = property  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n\u00a0\u00a0\u00a0\u00a0AuthorizationManager build(BaseObject configurationObject) {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return { documentIds ->  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0documentIds.collectEntries { id -> [id, true] }  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0}  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n\u00a0\u00a0\u00a0\u00a0EntityReference getConfigurationClassReference() {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return new LocalDocumentReference('Custom Right Check', 'Class')  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n\u00a0\u00a0\u00a0\u00a0EntityReference getConfigurationSheetReference() {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return new LocalDocumentReference('Custom Right Check', 'Sheet')  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n\u00a0\u00a0\u00a0\u00a0Class getConfigurationType() {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return ConfigurationType.class  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n\u00a0\u00a0\u00a0\u00a0Object getConfiguration(BaseObject object) {  \n \u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return new ConfigurationType(object.getStringValue(\"property\"))  \n \u00a0\u00a0\u00a0}  \n  \n \u00a0\u00a0\u00a0@Override  \n \u00a0\u00a0\u00a0void setConfiguration(BaseObject object, Object configuration) {  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0object.setStringValue(\"property\", configuration.property)  \n \u00a0\u00a0\u00a0}  \n}\u00a0This code assume an XClass Custom Right Check.Class with a property string \"property\" and a sheet Custom Right Check.Sheet to display this property.\n\nThe sheet should contribute one or several dt and dd elements that are displayed in the configuration of the collection. A possible sheet would be the following.\n\n{{velocity}}  \n#set ($object = $doc.getObject('Custom Right Check.Class', true))  \n#set ($editing = $xcontext.action == 'edit')  \n#set ($discard = $doc.use($object))  \n{{html clean=\"false\"}}<dt #if (!$editing && $hasEdit)  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0class=\"editableProperty\"  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data-property=\"$escapetool.xml($services.model.serialize($object.getPropertyReference('property')))\"  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data-object-policy=\"updateOrCreate\"  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0data-property-type=\"object\"#end>  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0<label#if ($editing) for=\"Custom Right Check.Class\\_0\\_property\"#end>  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0$escapetool.xml($doc.displayPrettyName('property', false, false))  \n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0</label>  \n\u00a0\u00a0\u00a0\u00a0</dt>  \n{{/html}}  \n  \n{{html clean=\"false\"}}<dd>{{/html}}  \n  \n$doc.display('property')  \n  \n{{html clean=\"false\"}}</dd>{{/html}}  \n{{/velocity}}It is important to use the updateOrCreate object policy as there is no separate code for adding the object. Further, this sheet will be applied also on documents that don't contain the configuration object yet, so it is important that the sheet creates it (first line of the code). This sheet is then dynamically loaded when the respective right check method is selected. When another value is selected, the sheet could be hidden again. The sheet thus shouldn't assume that when it is used it is also visible. In case any validation shall be performed, the sheet should verify that it is actually visible before performing any validation.\n\n\n"}